<!DOCTYPE html>
<html lang="en">
<head>
<!-- 2019-05-23 Thu 15:32 -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Distribution deconvolution examples</title>
<meta name="generator" content="Org mode">
<meta name="author" content="Abhishek Sarkar">
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<link href="css/bootstrap.min.css" rel="stylesheet" />
<link rel="stylesheet" type="text/css" href="css/htmlize.css"/>
<link rel="stylesheet" type="text/css" href="css/supp.css"/>
<style type="text/css">body {width: 60em; margin:auto} pre.src {overflow:auto}</style>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2017 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">Distribution deconvolution examples</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org1335f5a">Introduction</a></li>
<li><a href="#setup">Setup</a></li>
<li><a href="#org8bfc9be">Results</a>
<ul>
<li><a href="#orgf161875">Test</a></li>
<li><a href="#org3a73f38">Metadata</a></li>
<li><a href="#orge1f371e">Spike-in data</a></li>
<li><a href="#orgef19613">Homogeneous populations</a></li>
<li><a href="#org442ed69">Synthetic mixtures</a></li>
<li><a href="#org97b471c">Heterogeneous populations</a></li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-org1335f5a" class="outline-2">
<h2 id="org1335f5a">Introduction</h2>
<div class="outline-text-2" id="text-org1335f5a">
<p>
We systematically compared different deconvolution methods on their ability
to generalize to held out data. Here, we look at the data and fitted
distributions for specific examples.
</p>
</div>
</div>

<div id="outline-container-org1f0d593" class="outline-2">
<h2 id="setup"><a id="org1f0d593"></a>Setup</h2>
<div class="outline-text-2" id="text-setup">
<div class="org-src-container">
<pre class="src src-ipython"><span class="org-keyword">import</span> functools <span class="org-keyword">as</span> ft
<span class="org-keyword">import</span> multiprocessing <span class="org-keyword">as</span> mp
<span class="org-keyword">import</span> numpy <span class="org-keyword">as</span> np
<span class="org-keyword">import</span> pandas <span class="org-keyword">as</span> pd
<span class="org-keyword">import</span> scanpy
<span class="org-keyword">import</span> scipy.stats <span class="org-keyword">as</span> st
<span class="org-keyword">import</span> scipy.special <span class="org-keyword">as</span> sp
<span class="org-keyword">import</span> scmodes
<span class="org-keyword">import</span> sklearn.model_selection <span class="org-keyword">as</span> skms

<span class="org-keyword">import</span> rpy2.robjects.packages
<span class="org-keyword">import</span> rpy2.robjects.pandas2ri
<span class="org-keyword">import</span> rpy2.robjects.numpy2ri

rpy2.robjects.pandas2ri.activate()
rpy2.robjects.numpy2ri.activate()

<span class="org-variable-name">ashr</span> = rpy2.robjects.packages.importr(<span class="org-string">'ashr'</span>)
<span class="org-variable-name">descend</span> = rpy2.robjects.packages.importr(<span class="org-string">'descend'</span>)
</pre>
</div>

<div class="org-src-container">
<pre class="src src-ipython">%matplotlib inline
%config <span class="org-variable-name">InlineBackend.figure_formats</span> = <span class="org-builtin">set</span>([<span class="org-string">'retina'</span>])
</pre>
</div>

<div class="org-src-container">
<pre class="src src-ipython"><span class="org-keyword">import</span> colorcet
<span class="org-keyword">import</span> matplotlib.pyplot <span class="org-keyword">as</span> plt
<span class="org-variable-name">plt.rcParams</span>[<span class="org-string">'figure.facecolor'</span>] = <span class="org-string">'w'</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org8bfc9be" class="outline-2">
<h2 id="org8bfc9be">Results</h2>
<div class="outline-text-2" id="text-org8bfc9be">
</div>
<div id="outline-container-orgf161875" class="outline-3">
<h3 id="orgf161875">Test</h3>
<div class="outline-text-3" id="text-orgf161875">
<div class="org-src-container">
<pre class="src src-ipython"><span class="org-variable-name">b_cells</span> = scmodes.dataset.read_10x(<span class="org-string">'/project2/mstephens/aksarkar/projects/singlecell-ideas/data/10xgenomics/b_cells/filtered_matrices_mex/hg19/'</span>, return_df=<span class="org-constant">True</span>)
<span class="org-variable-name">llik_diff</span> = benchmark[<span class="org-string">'b_cells'</span>][<span class="org-string">'npmle'</span>] - benchmark[<span class="org-string">'b_cells'</span>][<span class="org-string">'gamma'</span>]
<span class="org-variable-name">query</span> = llik_diff[llik_diff &gt; 0].sort_values(ascending=<span class="org-constant">False</span>).head(n=1).index
</pre>
</div>

<div class="org-src-container">
<pre class="src src-ipython"><span class="org-variable-name">x</span> = b_cells[query].values.ravel()
<span class="org-variable-name">s</span> = b_cells.<span class="org-builtin">sum</span>(axis=1).values.ravel()
</pre>
</div>

<div class="org-src-container">
<pre class="src src-ipython">plt.clf()
<span class="org-variable-name">fig</span>, <span class="org-variable-name">ax</span> = plt.subplots(2, 1)
fig.set_size_inches(6, 4)
ax[0].hist(x, bins=np.arange(x.<span class="org-builtin">max</span>() + 1), color=<span class="org-string">'k'</span>)
ax[0].set_xlabel(<span class="org-string">'Num mols'</span>)
ax[0].set_ylabel(<span class="org-string">'Num cells'</span>)

<span class="org-keyword">for</span> c, k <span class="org-keyword">in</span> <span class="org-builtin">zip</span>(plt.get_cmap(<span class="org-string">'Dark2'</span>).colors, [<span class="org-string">'Gamma'</span>, <span class="org-string">'ZIG'</span>, <span class="org-string">'Unimodal'</span>, <span class="org-string">'ZIEF'</span>, <span class="org-string">'NPMLE'</span>]):
  ax[1].plot(*<span class="org-builtin">getattr</span>(scmodes.deconvolve, f<span class="org-string">'fit_{k.lower()}'</span>)(x, s), color=c, lw=1, label=k)
ax[1].set_xlabel(<span class="org-string">'Latent gene expression'</span>)
ax[1].set_ylabel(<span class="org-string">'CDF'</span>)
ax[1].legend(frameon=<span class="org-constant">False</span>)
fig.tight_layout()
</pre>
</div>


<div class="figure">
<p><img src="figure/deconvolution.org/test.png" alt="test.png">
</p>
</div>
</div>
</div>

<div id="outline-container-org3a73f38" class="outline-3">
<h3 id="org3a73f38">Metadata</h3>
<div class="outline-text-3" id="text-org3a73f38">
<p>
Read gene metadata.
</p>

<div class="org-src-container">
<pre class="src src-ipython" id="orgabb7eab"><span class="org-variable-name">gene_info</span> = pd.read_csv(<span class="org-string">'/project2/mstephens/aksarkar/projects/singlecell-qtl/data/scqtl-genes.txt.gz'</span>, sep=<span class="org-string">'\t'</span>, index_col=0)
</pre>
</div>
</div>
</div>

<div id="outline-container-orge1f371e" class="outline-3">
<h3 id="orge1f371e">Spike-in data</h3>
<div class="outline-text-3" id="text-orge1f371e">
<p>
Read the results.
</p>

<div class="org-src-container">
<pre class="src src-ipython"><span class="org-variable-name">benchmark</span> = {
  k: g.reset_index(level=0, drop=<span class="org-constant">True</span>) <span class="org-keyword">for</span> k, g <span class="org-keyword">in</span>
  (pd.read_csv(<span class="org-string">'/project2/mstephens/aksarkar/projects/singlecell-modes/data/deconv-generalization/control-kl.txt.gz'</span>,
               sep=<span class="org-string">'\t'</span>, index_col=[0, 1])
   .groupby(level=0))}
</pre>
</div>

<p>
We are primarily interested in cases where NPMLE does better than unimodal,
because these could potentially be cases where zeros drive the difference
in generalization performance.
</p>

<div class="org-src-container">
<pre class="src src-ipython"><span class="org-variable-name">chromium1</span> = data[<span class="org-string">'chromium1'</span>]()
<span class="org-variable-name">llik_diff</span> = benchmark[<span class="org-string">'chromium1'</span>][<span class="org-string">'npmle'</span>] - benchmark[<span class="org-string">'chromium1'</span>][<span class="org-string">'unimodal'</span>]
<span class="org-variable-name">query</span> = llik_diff[np.logical_and(chromium1.<span class="org-builtin">sum</span>(axis=0) &gt; 0, llik_diff &gt; 0)].sort_values(ascending=<span class="org-constant">False</span>).head(n=12).index
plt.clf()
<span class="org-variable-name">fig</span>, <span class="org-variable-name">ax</span> = plt.subplots(4, 3)
fig.set_size_inches(7, 5)
<span class="org-keyword">for</span> a, k <span class="org-keyword">in</span> <span class="org-builtin">zip</span>(ax.ravel(), query):
  a.hist(chromium1[:,k], bins=np.arange(chromium1[:,k].<span class="org-builtin">max</span>() + 2), color=<span class="org-string">'k'</span>)
  a.text(x=.95, y=.95,
         s=f<span class="org-string">"$\Delta KL$={llik_diff.loc[k]:.1f}"</span>,
         horizontalalignment=<span class="org-string">'right'</span>,
         verticalalignment=<span class="org-string">'top'</span>,
         transform=a.transAxes)
<span class="org-keyword">for</span> y <span class="org-keyword">in</span> <span class="org-builtin">range</span>(ax.shape[0]):
  ax[y][0].set_ylabel(<span class="org-string">'Num cells'</span>)
<span class="org-keyword">for</span> x <span class="org-keyword">in</span> <span class="org-builtin">range</span>(ax.shape[1]):
  ax[-1][x].set_xlabel(<span class="org-string">'Num mols'</span>)
fig.tight_layout()
</pre>
</div>


<div class="figure">
<p><img src="figure/deconvolution.org/chromium1-npmle-examples.png" alt="chromium1-npmle-examples.png">
</p>
</div>

<div class="org-src-container">
<pre class="src src-ipython"><span class="org-variable-name">chromium2</span> = data[<span class="org-string">'chromium2'</span>]()
<span class="org-variable-name">llik_diff</span> = benchmark[<span class="org-string">'chromium2'</span>][<span class="org-string">'npmle'</span>] - benchmark[<span class="org-string">'chromium2'</span>][<span class="org-string">'unimodal'</span>]
<span class="org-variable-name">query</span> = llik_diff[np.logical_and(chromium2.<span class="org-builtin">sum</span>(axis=0) &gt; 0, llik_diff &gt; 0)].sort_values(ascending=<span class="org-constant">False</span>).head(n=12).index
</pre>
</div>

<div class="org-src-container">
<pre class="src src-ipython">plt.clf()
<span class="org-variable-name">fig</span>, <span class="org-variable-name">ax</span> = plt.subplots(4, 3)
fig.set_size_inches(7, 5)
<span class="org-keyword">for</span> a, k <span class="org-keyword">in</span> <span class="org-builtin">zip</span>(ax.ravel(), query):
  a.hist(chromium2[:,k], bins=np.arange(chromium2[:,k].<span class="org-builtin">max</span>() + 2), color=<span class="org-string">'k'</span>)
  a.text(x=.95, y=.95,
         s=f<span class="org-string">"$\Delta KL$={llik_diff.loc[k]:.1f}"</span>,
         horizontalalignment=<span class="org-string">'right'</span>,
         verticalalignment=<span class="org-string">'top'</span>,
         transform=a.transAxes)
<span class="org-keyword">for</span> y <span class="org-keyword">in</span> <span class="org-builtin">range</span>(ax.shape[0]):
  ax[y][0].set_ylabel(<span class="org-string">'Num cells'</span>)
<span class="org-keyword">for</span> x <span class="org-keyword">in</span> <span class="org-builtin">range</span>(ax.shape[1]):
  ax[-1][x].set_xlabel(<span class="org-string">'Num mols'</span>)
fig.tight_layout()
</pre>
</div>


<div class="figure">
<p><img src="figure/deconvolution.org/chromium2-npmle-examples.png" alt="chromium2-npmle-examples.png">
</p>
</div>

<div class="org-src-container">
<pre class="src src-ipython"><span class="org-variable-name">dropseq</span> = data[<span class="org-string">'dropseq'</span>]()
<span class="org-variable-name">llik_diff</span> = benchmark[<span class="org-string">'dropseq'</span>][<span class="org-string">'npmle'</span>] - benchmark[<span class="org-string">'dropseq'</span>][<span class="org-string">'unimodal'</span>]
<span class="org-variable-name">query</span> = benchmark[<span class="org-string">'dropseq'</span>].loc[llik_diff[llik_diff &gt; 0].sort_values(ascending=<span class="org-constant">False</span>).head(n=12).index].index
plt.clf()
<span class="org-variable-name">fig</span>, <span class="org-variable-name">ax</span> = plt.subplots(4, 3)
fig.set_size_inches(7, 5)
<span class="org-keyword">for</span> a, k <span class="org-keyword">in</span> <span class="org-builtin">zip</span>(ax.ravel(), query):
  a.hist(dropseq[:,k], bins=np.arange(dropseq[:,k].<span class="org-builtin">max</span>() + 2), color=<span class="org-string">'k'</span>)
  a.text(x=.95, y=.95,
         s=f<span class="org-string">"$\Delta KL$={llik_diff.loc[k]:.1f}"</span>,
         horizontalalignment=<span class="org-string">'right'</span>,
         verticalalignment=<span class="org-string">'top'</span>,
         transform=a.transAxes)
<span class="org-keyword">for</span> y <span class="org-keyword">in</span> <span class="org-builtin">range</span>(ax.shape[0]):
  ax[y][0].set_ylabel(<span class="org-string">'Num cells'</span>)
<span class="org-keyword">for</span> x <span class="org-keyword">in</span> <span class="org-builtin">range</span>(ax.shape[1]):
  ax[-1][x].set_xlabel(<span class="org-string">'Num mols'</span>)
fig.tight_layout()
</pre>
</div>


<div class="figure">
<p><img src="figure/deconvolution.org/dropseq-npmle-examples.png" alt="dropseq-npmle-examples.png">
</p>
</div>

<div class="org-src-container">
<pre class="src src-ipython"><span class="org-variable-name">gemcode</span> = data[<span class="org-string">'gemcode'</span>]()
<span class="org-variable-name">llik_diff</span> = benchmark[<span class="org-string">'gemcode'</span>][<span class="org-string">'npmle'</span>] - benchmark[<span class="org-string">'gemcode'</span>][<span class="org-string">'unimodal'</span>]
<span class="org-variable-name">query</span> = llik_diff[np.logical_and(gemcode.<span class="org-builtin">sum</span>(axis=0) &gt; 0, llik_diff &gt; 0)].sort_values(ascending=<span class="org-constant">False</span>).head(n=12).index
plt.clf()
<span class="org-variable-name">fig</span>, <span class="org-variable-name">ax</span> = plt.subplots(4, 3)
fig.set_size_inches(7, 5)
<span class="org-keyword">for</span> a, k <span class="org-keyword">in</span> <span class="org-builtin">zip</span>(ax.ravel(), query):
  a.hist(gemcode[:,k], bins=np.arange(gemcode[:,k].<span class="org-builtin">max</span>() + 2), color=<span class="org-string">'k'</span>)
  a.text(x=.95, y=.95,
         s=f<span class="org-string">"$\Delta KL$={llik_diff.loc[k]:.1f}"</span>,
         horizontalalignment=<span class="org-string">'right'</span>,
         verticalalignment=<span class="org-string">'top'</span>,
         transform=a.transAxes)
<span class="org-keyword">for</span> y <span class="org-keyword">in</span> <span class="org-builtin">range</span>(ax.shape[0]):
  ax[y][0].set_ylabel(<span class="org-string">'Num cells'</span>)
<span class="org-keyword">for</span> x <span class="org-keyword">in</span> <span class="org-builtin">range</span>(ax.shape[1]):
  ax[-1][x].set_xlabel(<span class="org-string">'Num mols'</span>)
fig.tight_layout()

</pre>
</div>


<div class="figure">
<p><img src="figure/deconvolution.org/gemcode-npmle-examples.png" alt="gemcode-npmle-examples.png">
</p>
</div>

<div class="org-src-container">
<pre class="src src-ipython"><span class="org-variable-name">indrops</span> = data[<span class="org-string">'indrops'</span>]()
<span class="org-variable-name">llik_diff</span> = benchmark[<span class="org-string">'indrops'</span>][<span class="org-string">'npmle'</span>] - benchmark[<span class="org-string">'indrops'</span>][<span class="org-string">'unimodal'</span>]
<span class="org-variable-name">query</span> = llik_diff[np.logical_and(indrops.<span class="org-builtin">sum</span>(axis=0) &gt; 0, llik_diff &gt; 0)].sort_values(ascending=<span class="org-constant">False</span>).head(n=12).index
plt.clf()
<span class="org-variable-name">fig</span>, <span class="org-variable-name">ax</span> = plt.subplots(4, 3)
fig.set_size_inches(7, 5)
<span class="org-keyword">for</span> a, k <span class="org-keyword">in</span> <span class="org-builtin">zip</span>(ax.ravel(), query):
  a.hist(indrops[:,k], bins=np.arange(indrops[:,k].<span class="org-builtin">max</span>() + 2), color=<span class="org-string">'k'</span>)
  a.text(x=.95, y=.95,
         s=f<span class="org-string">"$\Delta KL$={llik_diff.loc[k]:.1f}"</span>,
         horizontalalignment=<span class="org-string">'right'</span>,
         verticalalignment=<span class="org-string">'top'</span>,
         transform=a.transAxes)
<span class="org-keyword">for</span> y <span class="org-keyword">in</span> <span class="org-builtin">range</span>(ax.shape[0]):
  ax[y][0].set_ylabel(<span class="org-string">'Num cells'</span>)
<span class="org-keyword">for</span> x <span class="org-keyword">in</span> <span class="org-builtin">range</span>(ax.shape[1]):
  ax[-1][x].set_xlabel(<span class="org-string">'Num mols'</span>)
fig.tight_layout()

</pre>
</div>


<div class="figure">
<p><img src="figure/deconvolution.org/indrops-npmle-examples.png" alt="indrops-npmle-examples.png">
</p>
</div>
</div>
</div>

<div id="outline-container-orgef19613" class="outline-3">
<h3 id="orgef19613">Homogeneous populations</h3>
<div class="outline-text-3" id="text-orgef19613">
<p>
Read the results.
</p>

<div class="org-src-container">
<pre class="src src-ipython"><span class="org-variable-name">benchmark</span> = {
  k: g.reset_index(level=0, drop=<span class="org-constant">True</span>) <span class="org-keyword">for</span> k, g <span class="org-keyword">in</span>
  (pd.read_csv(<span class="org-string">'/project2/mstephens/aksarkar/projects/singlecell-modes/data/deconv-generalization/homogeneous-kl.txt.gz'</span>,
               sep=<span class="org-string">'\t'</span>, index_col=[0, 1])
   .groupby(level=0))}

</pre>
</div>

<p>
Focus on cases where NPMLE does better than unimodal. Look at B cells.
</p>

<div class="org-src-container">
<pre class="src src-ipython"><span class="org-variable-name">b_cells</span> = scmodes.dataset.read_10x(<span class="org-string">'/project2/mstephens/aksarkar/projects/singlecell-ideas/data/10xgenomics/b_cells/filtered_matrices_mex/hg19/'</span>, return_df=<span class="org-constant">True</span>)
<span class="org-variable-name">llik_diff</span> = benchmark[<span class="org-string">'b_cells'</span>][<span class="org-string">'npmle'</span>] - benchmark[<span class="org-string">'b_cells'</span>][<span class="org-string">'unimodal'</span>]
<span class="org-variable-name">query</span> = llik_diff[llik_diff &gt; 0].sort_values(ascending=<span class="org-constant">False</span>).head(n=12).index
</pre>
</div>

<div class="org-src-container">
<pre class="src src-ipython">plt.clf()
<span class="org-variable-name">fig</span>, <span class="org-variable-name">ax</span> = plt.subplots(3, 4)
fig.set_size_inches(7, 5)
<span class="org-keyword">for</span> a, k <span class="org-keyword">in</span> <span class="org-builtin">zip</span>(ax.ravel(), query):
  a.hist(b_cells.loc[:,k], bins=np.arange(b_cells.loc[:,k].<span class="org-builtin">max</span>() + 1), color=<span class="org-string">'k'</span>)
  a.text(x=.95, y=.95,
         s=f<span class="org-string">"$\Delta KL$={llik_diff.loc[k]:.1g}"</span>,
         horizontalalignment=<span class="org-string">'right'</span>,
         verticalalignment=<span class="org-string">'top'</span>,
         transform=a.transAxes)
  a.set_title(gene_info.loc[k, <span class="org-string">'name'</span>] <span class="org-keyword">if</span> k <span class="org-keyword">in</span> gene_info.index <span class="org-keyword">else</span> k)
<span class="org-keyword">for</span> y <span class="org-keyword">in</span> <span class="org-builtin">range</span>(ax.shape[0]):
  ax[y][0].set_ylabel(<span class="org-string">'Num cells'</span>)
<span class="org-keyword">for</span> x <span class="org-keyword">in</span> <span class="org-builtin">range</span>(ax.shape[1]):
  ax[-1][x].set_xlabel(<span class="org-string">'Num mols'</span>)
fig.tight_layout()
</pre>
</div>


<div class="figure">
<p><img src="figure/deconvolution.org/b-cell-npmle-examples.png" alt="b-cell-npmle-examples.png">
</p>
</div>

<p>
Look at cytotoxic T cells.
</p>

<div class="org-src-container">
<pre class="src src-ipython"><span class="org-variable-name">cytotoxic_t</span> = scmodes.dataset.read_10x(<span class="org-string">'/project2/mstephens/aksarkar/projects/singlecell-ideas/data/10xgenomics/cytotoxic_t/filtered_matrices_mex/hg19/'</span>, return_df=<span class="org-constant">True</span>)
<span class="org-variable-name">llik_diff</span> = benchmark[<span class="org-string">'cytotoxic_t'</span>][<span class="org-string">'npmle'</span>] - benchmark[<span class="org-string">'cytotoxic_t'</span>][<span class="org-string">'unimodal'</span>]
<span class="org-variable-name">query</span> = llik_diff[llik_diff &gt; 0].sort_values(ascending=<span class="org-constant">False</span>).head(n=12).index
</pre>
</div>

<div class="org-src-container">
<pre class="src src-ipython">plt.clf()
<span class="org-variable-name">fig</span>, <span class="org-variable-name">ax</span> = plt.subplots(4, 3)
fig.set_size_inches(7, 5)
<span class="org-keyword">for</span> a, k <span class="org-keyword">in</span> <span class="org-builtin">zip</span>(ax.ravel(), query):
  a.hist(cytotoxic_t.loc[:,k], bins=np.arange(cytotoxic_t.loc[:,k].<span class="org-builtin">max</span>() + 1), color=<span class="org-string">'k'</span>)
  a.text(x=.95, y=.95,
         s=f<span class="org-string">"$\Delta KL$={llik_diff.loc[k]:.1g}"</span>,
         horizontalalignment=<span class="org-string">'right'</span>,
         verticalalignment=<span class="org-string">'top'</span>,
         transform=a.transAxes)
  a.set_title(gene_info.loc[k, <span class="org-string">'name'</span>] <span class="org-keyword">if</span> k <span class="org-keyword">in</span> gene_info.index <span class="org-keyword">else</span> k)
<span class="org-keyword">for</span> y <span class="org-keyword">in</span> <span class="org-builtin">range</span>(ax.shape[0]):
  ax[y][0].set_ylabel(<span class="org-string">'Num cells'</span>)
<span class="org-keyword">for</span> x <span class="org-keyword">in</span> <span class="org-builtin">range</span>(ax.shape[1]):
  ax[-1][x].set_xlabel(<span class="org-string">'Num mols'</span>)
fig.tight_layout()
</pre>
</div>


<div class="figure">
<p><img src="figure/deconvolution.org/cytotoxic-t-npmle-examples.png" alt="cytotoxic-t-npmle-examples.png">
</p>
</div>

<p>
Make sure our choice of discretization for unimodal is acceptable on
<i>RPL34</i>.
</p>

<div class="org-src-container">
<pre class="src src-ipython"><span class="org-variable-name">k</span> = <span class="org-string">'ENSG00000109475'</span>
<span class="org-variable-name">x</span> = cytotoxic_t.loc[:,k]
<span class="org-variable-name">s</span> = cytotoxic_t.<span class="org-builtin">sum</span>(axis=1)

plt.clf()
<span class="org-variable-name">fig</span>, <span class="org-variable-name">ax</span> = plt.subplots(2, 1)
fig.set_size_inches(6, 4)
ax[0].hist(x, bins=np.arange(x.<span class="org-builtin">max</span>() + 1), color=<span class="org-string">'k'</span>)
ax[0].set_xlabel(<span class="org-string">'Num mols'</span>)
ax[0].set_ylabel(<span class="org-string">'Num cells'</span>)

<span class="org-keyword">for</span> c, k <span class="org-keyword">in</span> <span class="org-builtin">zip</span>(plt.get_cmap(<span class="org-string">'Dark2'</span>).colors, [<span class="org-string">'Gamma'</span>, <span class="org-string">'ZIG'</span>, <span class="org-string">'Unimodal'</span>, <span class="org-string">'ZIEF'</span>, <span class="org-string">'NPMLE'</span>]):
  ax[1].plot(*<span class="org-builtin">getattr</span>(scmodes.deconvolve, f<span class="org-string">'fit_{k.lower()}'</span>)(x, s), color=c, lw=1, label=k)
ax[1].set_xlabel(<span class="org-string">'Latent gene expression'</span>)
ax[1].set_ylabel(<span class="org-string">'CDF'</span>)
ax[1].legend(frameon=<span class="org-constant">False</span>)
fig.tight_layout()
</pre>
</div>


<div class="figure">
<p><img src="figure/deconvolution.org/cytotoxic-t-rpl34.png" alt="cytotoxic-t-rpl34.png">
</p>
</div>

<p>
Mengyin Lu previously reported <i>CCL5</i> could possibly have bimodal
expression. Look at the fitted distributions for <i>CCL5</i>.
</p>

<div class="org-src-container">
<pre class="src src-ipython"><span class="org-variable-name">k</span> = <span class="org-string">'ENSG00000161570'</span>
<span class="org-variable-name">x</span> = cytotoxic_t.loc[:,k]
<span class="org-variable-name">s</span> = cytotoxic_t.<span class="org-builtin">sum</span>(axis=1)

plt.clf()
<span class="org-variable-name">fig</span>, <span class="org-variable-name">ax</span> = plt.subplots(2, 1)
fig.set_size_inches(6, 4)
ax[0].hist(x, bins=np.arange(x.<span class="org-builtin">max</span>() + 1), color=<span class="org-string">'k'</span>)
ax[0].set_xlabel(<span class="org-string">'Num mols'</span>)
ax[0].set_ylabel(<span class="org-string">'Num cells'</span>)

<span class="org-keyword">for</span> c, k <span class="org-keyword">in</span> <span class="org-builtin">zip</span>(plt.get_cmap(<span class="org-string">'Dark2'</span>).colors, [<span class="org-string">'Gamma'</span>, <span class="org-string">'ZIG'</span>, <span class="org-string">'Unimodal'</span>, <span class="org-string">'ZIEF'</span>, <span class="org-string">'NPMLE'</span>]):
  ax[1].plot(*<span class="org-builtin">getattr</span>(scmodes.deconvolve, f<span class="org-string">'fit_{k.lower()}'</span>)(x, s), color=c, lw=1, label=k)
ax[1].set_xlabel(<span class="org-string">'Latent gene expression'</span>)
ax[1].set_ylabel(<span class="org-string">'CDF'</span>)
ax[1].legend(frameon=<span class="org-constant">False</span>)
fig.tight_layout()
</pre>
</div>


<div class="figure">
<p><img src="figure/deconvolution.org/cytotoxic-t-ccl5.png" alt="cytotoxic-t-ccl5.png">
</p>
</div>

<p>
Look at iPSCs.
</p>

<div class="org-src-container">
<pre class="src src-ipython"><span class="org-variable-name">ipsc_counts</span> = scmodes.dataset.ipsc(<span class="org-string">'/project2/mstephens/aksarkar/projects/singlecell-qtl/data/'</span>, n=100, return_df=<span class="org-constant">True</span>)
<span class="org-variable-name">llik_diff</span> = benchmark[<span class="org-string">'ipsc'</span>][<span class="org-string">'npmle'</span>] - benchmark[<span class="org-string">'ipsc'</span>][<span class="org-string">'unimodal'</span>]
<span class="org-variable-name">query</span> = llik_diff[llik_diff &gt; 0].sort_values(ascending=<span class="org-constant">False</span>).head(n=12).index
</pre>
</div>

<div class="org-src-container">
<pre class="src src-ipython">plt.clf()
<span class="org-variable-name">fig</span>, <span class="org-variable-name">ax</span> = plt.subplots(4, 3)
fig.set_size_inches(7, 5)
<span class="org-keyword">for</span> a, k <span class="org-keyword">in</span> <span class="org-builtin">zip</span>(ax.ravel(), query):
  <span class="org-variable-name">h</span> = a.hist(ipsc_counts.loc[:,k], bins=np.arange(ipsc_counts.loc[:,k].<span class="org-builtin">max</span>() + 1), color=<span class="org-string">'k'</span>)
  a.text(x=.95, y=.95,
         s=f<span class="org-string">"$\Delta KL$={llik_diff.loc[k]:.1g}"</span>,
         horizontalalignment=<span class="org-string">'right'</span>,
         verticalalignment=<span class="org-string">'top'</span>,
         transform=a.transAxes)
  a.set_title(gene_info.loc[k, <span class="org-string">'name'</span>])
<span class="org-keyword">for</span> y <span class="org-keyword">in</span> <span class="org-builtin">range</span>(ax.shape[0]):
  ax[y][0].set_ylabel(<span class="org-string">'Num cells'</span>)
<span class="org-keyword">for</span> x <span class="org-keyword">in</span> <span class="org-builtin">range</span>(ax.shape[1]):
  ax[-1][x].set_xlabel(<span class="org-string">'Num mols'</span>)
fig.tight_layout()
</pre>
</div>


<div class="figure">
<p><img src="figure/deconvolution.org/ipsc-unimodal-examples.png" alt="ipsc-unimodal-examples.png">
</p>
</div>

<p>
Compare against Gamma.
</p>

<div class="org-src-container">
<pre class="src src-ipython"><span class="org-variable-name">llik_diff</span> = benchmark[<span class="org-string">'ipsc'</span>][<span class="org-string">'npmle'</span>] - benchmark[<span class="org-string">'ipsc'</span>][<span class="org-string">'gamma'</span>]
<span class="org-variable-name">query</span> = llik_diff[llik_diff &gt; 0].sort_values(ascending=<span class="org-constant">False</span>).head(n=12).index
plt.clf()
<span class="org-variable-name">fig</span>, <span class="org-variable-name">ax</span> = plt.subplots(4, 3)
fig.set_size_inches(7, 5)
<span class="org-keyword">for</span> a, k <span class="org-keyword">in</span> <span class="org-builtin">zip</span>(ax.ravel(), query):
  a.hist(ipsc_counts.loc[:,k], bins=np.arange(ipsc_counts.loc[:,k].<span class="org-builtin">max</span>() + 1), color=<span class="org-string">'k'</span>)
  a.text(x=.95, y=.95,
         s=f<span class="org-string">"$\Delta KL$={llik_diff.loc[k]:.1g}"</span>,
         horizontalalignment=<span class="org-string">'right'</span>,
         verticalalignment=<span class="org-string">'top'</span>,
         transform=a.transAxes)
  a.set_title(gene_info.loc[k, <span class="org-string">'name'</span>])
<span class="org-keyword">for</span> y <span class="org-keyword">in</span> <span class="org-builtin">range</span>(ax.shape[0]):
  ax[y][0].set_ylabel(<span class="org-string">'Num cells'</span>)
<span class="org-keyword">for</span> x <span class="org-keyword">in</span> <span class="org-builtin">range</span>(ax.shape[1]):
  ax[-1][x].set_xlabel(<span class="org-string">'Num mols'</span>)
fig.tight_layout()
</pre>
</div>


<div class="figure">
<p><img src="figure/deconvolution.org/ipsc-npmle-examples.png" alt="ipsc-npmle-examples.png">
</p>
</div>

<ul class="org-ul">
<li><i>SLC25A5</i> (<a href="https://www.omim.org/entry/300150">Solute carrier family 25
member 5</a>) codes for a mitochrondrial membrane protein
(<a href="https://www.ncbi.nlm.nih.gov/pmc/articles/PMC5789311/">Rocha et
al. 2018</a>), and is altered in Parkinson's disease</li>
<li><i>TXNDC17</i> (<a href="https://www.omim.org/entry/616967">Thioredoxin
domain-containing protein 17</a>) appears to be involved in oxidative
stress</li>
</ul>

<p>
Look at the fitted distributions for <i>SLC25A5</i>.
</p>

<div class="org-src-container">
<pre class="src src-ipython"><span class="org-variable-name">k</span> = <span class="org-string">'ENSG00000005022'</span>
<span class="org-variable-name">x</span> = ipsc_counts.loc[:,k]
<span class="org-variable-name">s</span> = ipsc_counts.<span class="org-builtin">sum</span>(axis=1)

plt.clf()
<span class="org-variable-name">fig</span>, <span class="org-variable-name">ax</span> = plt.subplots(2, 1)
fig.set_size_inches(6, 4)
ax[0].hist(x, bins=np.arange(x.<span class="org-builtin">max</span>() + 1), color=<span class="org-string">'k'</span>)
ax[0].set_xlabel(<span class="org-string">'Num mols'</span>)
ax[0].set_ylabel(<span class="org-string">'Num cells'</span>)

<span class="org-keyword">for</span> c, k <span class="org-keyword">in</span> <span class="org-builtin">zip</span>(plt.get_cmap(<span class="org-string">'Dark2'</span>).colors, [<span class="org-string">'Gamma'</span>, <span class="org-string">'ZIG'</span>, <span class="org-string">'Unimodal'</span>, <span class="org-string">'ZIEF'</span>, <span class="org-string">'NPMLE'</span>]):
  ax[1].plot(*<span class="org-builtin">getattr</span>(scmodes.deconvolve, f<span class="org-string">'fit_{k.lower()}'</span>)(x, s), color=c, lw=1, label=k)
ax[1].set_xlabel(<span class="org-string">'Latent gene expression'</span>)
ax[1].set_ylabel(<span class="org-string">'CDF'</span>)
ax[1].legend(frameon=<span class="org-constant">False</span>)
fig.tight_layout()
</pre>
</div>


<div class="figure">
<p><img src="figure/deconvolution.org/ipsc-slc25a5.png" alt="ipsc-slc25a5.png">
</p>
</div>

<p>
<b>Conclusions:</b>
</p>

<ul class="org-ul">
<li>When NPMLE does better than Gamma, unimodal does comparably well. The
genes where this happens quite clearly exhibit unimodal gene expression.</li>
</ul>
</div>

<div id="outline-container-orgcfc27cc" class="outline-4">
<h4 id="bimodal-example-ipsc"><a id="orgcfc27cc"></a>Investigate Gamma vs. Point-Gamma in high-depth data</h4>
<div class="outline-text-4" id="text-bimodal-example-ipsc">
<p>
Look at the full benchmark results for NB vs. ZINB (only the GPU
implementation is suitable for this).
</p>

<div class="org-src-container">
<pre class="src src-ipython"><span class="org-variable-name">ipsc_res</span> = pd.read_csv(<span class="org-string">'/project2/mstephens/aksarkar/projects/singlecell-modes/data/deconv-generalization/ipsc-gpu.txt.gz'</span>, index_col=0, sep=<span class="org-string">'\t'</span>)
</pre>
</div>

<div class="org-src-container">
<pre class="src src-ipython">plt.clf()
plt.gcf().set_size_inches(3, 3)
<span class="org-variable-name">h</span> = plt.hist(ipsc_res[<span class="org-string">'zinb'</span>] - ipsc_res[<span class="org-string">'nb'</span>], color=<span class="org-string">'k'</span>, bins=np.arange(-10, 40, 2))
plt.xlabel(<span class="org-string">'Diff val set log lik from NB'</span>)
<span class="org-variable-name">_</span> = plt.ylabel(<span class="org-string">'Number of genes'</span>)
</pre>
</div>


<div class="figure">
<p><img src="figure/deconvolution.org/homogeneous-nb-zinb-benchmark.png" alt="homogeneous-nb-zinb-benchmark.png">
</p>
</div>

<p>
Print the histogram for inspection.
</p>

<div class="org-src-container">
<pre class="src src-ipython">np.vstack((h[1][:-1], h[0])).T.astype(<span class="org-builtin">int</span>)
</pre>
</div>

<pre class="example">
array([[ -10,    0],
[  -8,    0],
[  -6,    0],
[  -4,    0],
[  -2, 4977],
[   0, 4973],
[   2,    2],
[   4,    3],
[   6,    0],
[   8,    0],
[  10,    0],
[  12,    0],
[  14,    1],
[  16,    0],
[  18,    0],
[  20,    0],
[  22,    0],
[  24,    0],
[  26,    0],
[  28,    1],
[  30,    0],
[  32,    0],
[  34,    0],
[  36,    0]])
</pre>

<p>
Try to find a case in the full iPSC data where point-Gamma (ZINB) is
required, by performing likelihood ratio tests against Gamma (NB). Use
Bonferroni correction to control FWER.
</p>

<div class="org-src-container">
<pre class="src src-ipython"><span class="org-variable-name">lrt</span> = st.chi2(1).sf(-2 * (ipsc_res[<span class="org-string">'gamma'</span>] - ipsc_res[<span class="org-string">'point_gamma'</span>]))
ipsc_res[lrt &lt; .05 / lrt.shape[0]]
</pre>
</div>

<pre class="example">
gamma  point_gamma
gene
ENSG00000112530 -2017.717750 -1987.894352
ENSG00000129824 -1803.651932 -1789.106410
</pre>

<p>
The two genes are <i>PACRG</i> and <i>RPS4Y1</i>. Look at the fitted distributions
for these genes.
</p>

<div class="org-src-container">
<pre class="src src-ipython"><span class="org-variable-name">ipsc_counts</span> = scmodes.dataset.ipsc(prefix=<span class="org-string">'/project2/mstephens/aksarkar/projects/singlecell-qtl/data/'</span>,
                                   query=<span class="org-builtin">list</span>(ipsc_res[lrt &lt; .05 / lrt.shape[0]].index), return_df=<span class="org-constant">True</span>)
</pre>
</div>

<div class="org-src-container">
<pre class="src src-ipython"><span class="org-variable-name">annotation</span> = pd.read_csv(<span class="org-string">'/project2/mstephens/aksarkar/projects/singlecell-qtl/data/scqtl-annotation.txt'</span>, sep=<span class="org-string">'\t'</span>)
<span class="org-variable-name">keep_samples</span> = pd.read_csv(<span class="org-string">'/project2/mstephens/aksarkar/projects/singlecell-qtl/data/quality-single-cells.txt'</span>, index_col=0, header=<span class="org-constant">None</span>, sep=<span class="org-string">'\t'</span>)
<span class="org-variable-name">s</span> = annotation.loc[keep_samples.values.ravel(), <span class="org-string">'mol_hs'</span>]
</pre>
</div>

<div class="org-src-container">
<pre class="src src-ipython"><span class="org-variable-name">k</span> = <span class="org-string">'ENSG00000112530'</span>
<span class="org-variable-name">x</span> = ipsc_counts.loc[:,k].values

plt.clf()
<span class="org-variable-name">fig</span>, <span class="org-variable-name">ax</span> = plt.subplots(2, 1)
fig.set_size_inches(6, 4)
ax[0].hist(x, bins=np.arange(x.<span class="org-builtin">max</span>() + 1), color=<span class="org-string">'k'</span>)
ax[0].set_title(gene_info.loc[k, <span class="org-string">'name'</span>])
ax[0].set_xlabel(<span class="org-string">'Num mols'</span>)
ax[0].set_ylabel(<span class="org-string">'Num cells'</span>)

<span class="org-keyword">for</span> c, k <span class="org-keyword">in</span> <span class="org-builtin">zip</span>(plt.get_cmap(<span class="org-string">'Dark2'</span>).colors, [<span class="org-string">'Gamma'</span>, <span class="org-string">'ZIG'</span>, <span class="org-string">'Unimodal'</span>, <span class="org-string">'ZIEF'</span>, <span class="org-string">'NPMLE'</span>]):
  ax[1].plot(*<span class="org-builtin">getattr</span>(scmodes.deconvolve, f<span class="org-string">'fit_{k.lower()}'</span>)(x, s), color=c, lw=1, label=k)
ax[1].set_xlabel(<span class="org-string">'Latent gene expression'</span>)
ax[1].set_ylabel(<span class="org-string">'CDF'</span>)
ax[1].legend(frameon=<span class="org-constant">False</span>)
fig.tight_layout()
</pre>
</div>


<div class="figure">
<p><img src="figure/deconvolution.org/ipsc-pacrg.png" alt="ipsc-pacrg.png">
</p>
</div>

<p>
<i>PACRG</i> (<a href="https://www.omim.org/entry/608427">Parkin coregulated gene</a>)
shares a promoter with <i>PKRG</i> (<i>PARK2</i>;
<a href="https://www.omim.org/entry/602544?search=park2&amp;highlight=park2">Parkin</a>). PARKIN
is involved in a <a href="https://www.pnas.org/content/115/2/E180">signaling
pathway for mitochondria damage</a>, and mitochrondrial damage appears to be
relevant to neurodegenerative disease etiology
(<a href="https://www.ncbi.nlm.nih.gov/pubmed/29414602">Alzheimer's disease</a> and
<a href="https://www.pnas.org/content/115/2/E180">Parkinson's disease</a>).
Mitochrondrial damage could explain the bimodal distribution of <i>PACRG</i> in
the iPSC data: the reprogramming protocol could induce oxidative stress on
some of the cells, resulting in damage.
</p>

<div class="org-src-container">
<pre class="src src-ipython"><span class="org-variable-name">k</span> = <span class="org-string">'ENSG00000129824'</span>
<span class="org-variable-name">x</span> = ipsc_counts.loc[:,k].values

plt.clf()
<span class="org-variable-name">fig</span>, <span class="org-variable-name">ax</span> = plt.subplots(2, 1)
fig.set_size_inches(6, 4)
ax[0].hist(x, bins=np.arange(x.<span class="org-builtin">max</span>() + 1), color=<span class="org-string">'k'</span>)
ax[0].set_title(gene_info.loc[k, <span class="org-string">'name'</span>])
ax[0].set_xlabel(<span class="org-string">'Num mols'</span>)
ax[0].set_ylabel(<span class="org-string">'Num cells'</span>)

<span class="org-keyword">for</span> c, k <span class="org-keyword">in</span> <span class="org-builtin">zip</span>(plt.get_cmap(<span class="org-string">'Dark2'</span>).colors, [<span class="org-string">'Gamma'</span>, <span class="org-string">'ZIG'</span>, <span class="org-string">'Unimodal'</span>, <span class="org-string">'ZIEF'</span>, <span class="org-string">'NPMLE'</span>]):
  ax[1].plot(*<span class="org-builtin">getattr</span>(scmodes.deconvolve, f<span class="org-string">'fit_{k.lower()}'</span>)(x, s), color=c, lw=1, label=k)
ax[1].set_xlabel(<span class="org-string">'Latent gene expression'</span>)
ax[1].set_ylabel(<span class="org-string">'CDF'</span>)
ax[1].legend(frameon=<span class="org-constant">False</span>)
fig.tight_layout()
</pre>
</div>


<div class="figure">
<p><img src="figure/deconvolution.org/ipsc-rps4y1.png" alt="ipsc-rps4y1.png">
</p>
</div>

<p>
<i>RPS4Y1</i> (<a href="https://www.omim.org/entry/470000">Ribosomal protein S4,
Y-linked</a>) is on the Y chromosome, and therefore we should expect it to
only be expressed in males. The homologous gene on the X chromosome
(<a href="https://www.omim.org/entry/312760"><i>RPS4X</i></a>) has a different coding
sequence. Naively, sex-linkage should explain why this gene exhibits bimodal
gene expression.
</p>

<div class="org-src-container">
<pre class="src src-sh">curl -OL <span class="org-string">'http://ftp.1000genomes.ebi.ac.uk/vol1/ftp/technical/working/20130606_sample_info/20130606_sample_info.txt'</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-ipython"><span class="org-variable-name">donor_info</span> = pd.read_csv(<span class="org-string">'/project2/mstephens/aksarkar/projects/singlecell-modes/data/20130606_sample_info.txt'</span>, sep=<span class="org-string">'\t'</span>)
</pre>
</div>

<p>
Count how many cells come from females.
</p>

<div class="org-src-container">
<pre class="src src-ipython"><span class="org-variable-name">prefix</span> = <span class="org-string">'/project2/mstephens/aksarkar/projects/singlecell-qtl/data/'</span>
<span class="org-variable-name">annotations</span> = pd.read_csv(f<span class="org-string">'{prefix}/scqtl-annotation.txt'</span>, sep=<span class="org-string">'\t'</span>)
<span class="org-variable-name">keep_samples</span> = pd.read_csv(f<span class="org-string">'{prefix}/quality-single-cells.txt'</span>, sep=<span class="org-string">'\t'</span>, index_col=0, header=<span class="org-constant">None</span>)
<span class="org-variable-name">annotations</span> = annotations.loc[keep_samples.values.ravel()]
</pre>
</div>

<div class="org-src-container">
<pre class="src src-ipython">annotations.merge(donor_info, left_on=<span class="org-string">'chip_id'</span>, right_on=<span class="org-string">'Sample'</span>)[<span class="org-string">'Gender'</span>].value_counts()
</pre>
</div>

<pre class="example">
female    3109
male      2369
Name: Gender, dtype: int64
</pre>

<p>
Look at the fitted ZINB distribution per-individual for this gene.
</p>

<div class="org-src-container">
<pre class="src src-ipython"><span class="org-variable-name">ipsc_log_mu</span> = pd.read_csv(<span class="org-string">'/project2/mstephens/aksarkar/projects/singlecell-qtl/data/density-estimation/design1/zi2-log-mu.txt.gz'</span>, sep=<span class="org-string">' '</span>, index_col=0)
<span class="org-variable-name">ipsc_log_phi</span> = pd.read_csv(<span class="org-string">'/project2/mstephens/aksarkar/projects/singlecell-qtl/data/density-estimation/design1/zi2-log-phi.txt.gz'</span>, sep=<span class="org-string">' '</span>, index_col=0)
<span class="org-variable-name">ipsc_logodds</span> = pd.read_csv(<span class="org-string">'/project2/mstephens/aksarkar/projects/singlecell-qtl/data/density-estimation/design1/zi2-logodds.txt.gz'</span>, sep=<span class="org-string">' '</span>, index_col=0)
</pre>
</div>

<div class="org-src-container">
<pre class="src src-ipython"><span class="org-keyword">def</span> <span class="org-function-name">point_gamma_cdf</span>(grid, log_mu, log_phi, logodds):
  <span class="org-variable-name">res</span> = st.gamma(a=np.exp(-log_phi), scale=np.exp(log_mu + log_phi)).cdf(grid)
  <span class="org-variable-name">res</span> *= sp.expit(-logodds)
  <span class="org-variable-name">res</span> += sp.expit(logodds)
  <span class="org-keyword">return</span> res

<span class="org-variable-name">lam</span> = ipsc_counts.values / annotations[<span class="org-string">'mol_hs'</span>].values.reshape(-1, 1)
<span class="org-variable-name">grid</span> = np.linspace(lam.<span class="org-builtin">min</span>(), lam.<span class="org-builtin">max</span>(), 1000)
<span class="org-variable-name">cdfs</span> = np.array([[point_gamma_cdf(grid,
                                  ipsc_log_mu.loc[j, k],
                                  ipsc_log_phi.loc[j, k],
                                  ipsc_logodds.loc[j, k])
                  <span class="org-keyword">for</span> k <span class="org-keyword">in</span> ipsc_log_mu]
                 <span class="org-keyword">for</span> j <span class="org-keyword">in</span> ipsc_counts.columns
                 <span class="org-keyword">if</span> j != <span class="org-builtin">list</span>(ipsc_log_mu.columns).index(<span class="org-string">'NA18498'</span>)])
</pre>
</div>

<div class="org-src-container">
<pre class="src src-ipython">plt.clf()
<span class="org-variable-name">fig</span>, <span class="org-variable-name">ax</span> = plt.subplots(2, 1, sharex=<span class="org-constant">True</span>)
fig.set_size_inches(6, 4)
<span class="org-keyword">for</span> a, F, k <span class="org-keyword">in</span> <span class="org-builtin">zip</span>(ax, cdfs, ipsc_counts.columns):
  <span class="org-keyword">for</span> f <span class="org-keyword">in</span> F:
    a.set_xlim(0, 2e-4)
    a.set_xticks(np.linspace(0, 2e-4, 3))
    a.plot(grid, f, c=<span class="org-string">'k'</span>, lw=1, alpha=0.2)
  a.set_title(gene_info.loc[k, <span class="org-string">'name'</span>])
  a.set_ylabel(<span class="org-string">'CDF'</span>)
ax[-1].set_xlabel(<span class="org-string">'Latent gene expression'</span>)
fig.tight_layout()
</pre>
</div>


<div class="figure">
<p><img src="figure/deconvolution.org/ipsc-point-gamma-cdf-pacrg.png" alt="ipsc-point-gamma-cdf-pacrg.png">
</p>
</div>

<p>
Plot the estimated <i>RPS4Y1</i> latent gene expression, stratified by donor sex.
</p>

<div class="org-src-container">
<pre class="src src-ipython"><span class="org-variable-name">colors</span> = {k: <span class="org-string">'r'</span> <span class="org-keyword">if</span> v == <span class="org-string">'male'</span> <span class="org-keyword">else</span> <span class="org-string">'b'</span> <span class="org-keyword">for</span> k, v <span class="org-keyword">in</span>
          donor_info.set_index(<span class="org-string">'Sample'</span>)
          .<span class="org-builtin">filter</span>(items=<span class="org-builtin">list</span>(ipsc_log_mu.columns), axis=0)
          [<span class="org-string">'Gender'</span>]
          .iteritems()}
plt.clf()
plt.gcf().set_size_inches(3, 2)
<span class="org-keyword">for</span> f, k <span class="org-keyword">in</span> <span class="org-builtin">zip</span>(cdfs[1], ipsc_log_mu.columns):
  plt.xlim(0, 2e-4)
  plt.xticks(np.linspace(0, 2e-4, 3))
  plt.plot(grid, f, lw=1, alpha=0.2, c=colors.get(k, <span class="org-string">'k'</span>))
  <span class="org-variable-name">dummy</span> = [plt.Line2D([0], [0], c=<span class="org-string">'r'</span>), plt.Line2D([0], [0], c=<span class="org-string">'b'</span>)]
  plt.legend(dummy, [<span class="org-string">'Male'</span>, <span class="org-string">'Female'</span>], frameon=<span class="org-constant">False</span>)
  plt.title(<span class="org-string">'RPS4Y1'</span>)
  plt.ylabel(<span class="org-string">'CDF'</span>)
  plt.xlabel(<span class="org-string">'Latent gene expression'</span>)
</pre>
</div>


<div class="figure">
<p><img src="figure/deconvolution.org/ipsc-point-gamma-cdf-rps4y1.png" alt="ipsc-point-gamma-cdf-rps4y1.png">
</p>
</div>
</div>
</div>
</div>

<div id="outline-container-org442ed69" class="outline-3">
<h3 id="org442ed69">Synthetic mixtures</h3>
<div class="outline-text-3" id="text-org442ed69">
<p>
Read the results.
</p>

<div class="org-src-container">
<pre class="src src-ipython"><span class="org-variable-name">benchmark</span> = {
  k: g.reset_index(level=0, drop=<span class="org-constant">True</span>) <span class="org-keyword">for</span> k, g <span class="org-keyword">in</span>
  (pd.read_csv(<span class="org-string">'/project2/mstephens/aksarkar/projects/singlecell-modes/data/deconv-generalization/synthetic-mix-kl.txt.gz'</span>,
               sep=<span class="org-string">'\t'</span>, index_col=[0, 1])
   .groupby(level=0))}
</pre>
</div>

<p>
Read the data.
</p>

<div class="org-src-container">
<pre class="src src-ipython"><span class="org-variable-name">t_cells</span> = scmodes.dataset.read_10x(<span class="org-string">'/project2/mstephens/aksarkar/projects/singlecell-ideas/data/10xgenomics/cytotoxic_t/filtered_matrices_mex/hg19/'</span>, min_detect=0, return_df=<span class="org-constant">True</span>)
<span class="org-variable-name">b_cells</span> = scmodes.dataset.read_10x(<span class="org-string">'/project2/mstephens/aksarkar/projects/singlecell-ideas/data/10xgenomics/b_cells/filtered_matrices_mex/hg19/'</span>, min_detect=0, return_df=<span class="org-constant">True</span>)
<span class="org-variable-name">mix1</span>, <span class="org-variable-name">y1</span> = scmodes.dataset.synthetic_mix(t_cells, b_cells, min_detect=0.25)

<span class="org-variable-name">cyto</span> = scmodes.dataset.read_10x(prefix=<span class="org-string">'/project2/mstephens/aksarkar/projects/singlecell-ideas/data/10xgenomics/cytotoxic_t/filtered_matrices_mex/hg19'</span>, return_df=<span class="org-constant">True</span>, min_detect=0)
<span class="org-variable-name">naive</span> = scmodes.dataset.read_10x(prefix=<span class="org-string">'/project2/mstephens/aksarkar/projects/singlecell-ideas/data/10xgenomics/naive_cytotoxic/filtered_matrices_mex/hg19'</span>, return_df=<span class="org-constant">True</span>, min_detect=0)
<span class="org-variable-name">mix2</span>, <span class="org-variable-name">y2</span> = scmodes.dataset.synthetic_mix(cyto, naive, min_detect=0.25)
</pre>
</div>

<p>
Look at T cell/B cell mix.
</p>

<div class="org-src-container">
<pre class="src src-ipython"><span class="org-variable-name">llik_diff</span> = benchmark[<span class="org-string">'cd8-cd19-mix'</span>][<span class="org-string">'npmle'</span>] - benchmark[<span class="org-string">'cd8-cd19-mix'</span>][<span class="org-string">'unimodal'</span>]
<span class="org-variable-name">query</span> = benchmark[<span class="org-string">'cd8-cd19-mix'</span>].loc[llik_diff[llik_diff &gt; 0].sort_values(ascending=<span class="org-constant">False</span>).head(n=12).index].index.astype(<span class="org-builtin">int</span>)
plt.clf()
<span class="org-variable-name">fig</span>, <span class="org-variable-name">ax</span> = plt.subplots(3, 4)
fig.set_size_inches(8, 5)
<span class="org-keyword">for</span> a, k <span class="org-keyword">in</span> <span class="org-builtin">zip</span>(ax.ravel(), query):
  <span class="org-variable-name">h</span> = a.hist(mix1.loc[y1 == 1,mix1.columns[k]], bins=np.arange(mix1.iloc[:,k].<span class="org-builtin">max</span>() + 1), color=<span class="org-string">'k'</span>, alpha=0.6, label=<span class="org-string">'T cells'</span>)
  a.hist(mix1.loc[y1 == 0,mix1.columns[k]], bins=np.arange(mix1.iloc[:,k].<span class="org-builtin">max</span>() + 1), color=<span class="org-string">'r'</span>, alpha=0.6, label=<span class="org-string">'B cells'</span>)
  a.text(x=.95, y=.95,
         s=f<span class="org-string">"$\Delta KL$={llik_diff.iloc[k]:.1g}"</span>,
         horizontalalignment=<span class="org-string">'right'</span>,
         verticalalignment=<span class="org-string">'top'</span>,
         transform=a.transAxes)
  a.set_title(gene_info.loc[mix1.columns[k], <span class="org-string">'name'</span>] <span class="org-keyword">if</span> mix1.columns[k] <span class="org-keyword">in</span> gene_info.index <span class="org-keyword">else</span> mix1.columns[k])
<span class="org-variable-name">handles</span>, <span class="org-variable-name">labels</span> = a.get_legend_handles_labels()
fig.legend(handles, labels, frameon=<span class="org-constant">False</span>, loc=<span class="org-string">'center left'</span>, bbox_to_anchor=(1, 0.5))
<span class="org-keyword">for</span> a <span class="org-keyword">in</span> ax:
  a[0].set_ylabel(<span class="org-string">'Num cells'</span>)
<span class="org-keyword">for</span> a <span class="org-keyword">in</span> ax.T:
  a[-1].set_xlabel(<span class="org-string">'Num mols'</span>)
fig.tight_layout()
</pre>
</div>


<div class="figure">
<p><img src="figure/deconvolution.org/cd8-cd19-mix-npmle-examples.png" alt="cd8-cd19-mix-npmle-examples.png">
</p>
</div>

<p>
Look cytotoxic/naive T cell mix.
</p>

<div class="org-src-container">
<pre class="src src-ipython"><span class="org-variable-name">llik_diff</span> = benchmark[<span class="org-string">'cyto-naive-t-mix'</span>][<span class="org-string">'npmle'</span>] - benchmark[<span class="org-string">'cyto-naive-t-mix'</span>][<span class="org-string">'unimodal'</span>]
<span class="org-variable-name">query</span> = benchmark[<span class="org-string">'cyto-naive-t-mix'</span>].loc[llik_diff[llik_diff &gt; 0].sort_values(ascending=<span class="org-constant">False</span>).head(n=12).index].index
plt.clf()
<span class="org-variable-name">fig</span>, <span class="org-variable-name">ax</span> = plt.subplots(3, 4)
fig.set_size_inches(8, 5)
<span class="org-keyword">for</span> a, k <span class="org-keyword">in</span> <span class="org-builtin">zip</span>(ax.ravel(), query):
  a.hist(mix2.loc[y1 == 1,k], bins=np.arange(mix2.loc[:,k].<span class="org-builtin">max</span>() + 1), alpha=0.6, color=<span class="org-string">'k'</span>, label=<span class="org-string">'Cytotoxic T'</span>)
  a.hist(mix2.loc[y1 == 0,k], bins=np.arange(mix2.loc[:,k].<span class="org-builtin">max</span>() + 1), alpha=0.6, color=<span class="org-string">'r'</span>, label=<span class="org-string">'Naive T'</span>)
  a.text(x=.95, y=.95,
         s=f<span class="org-string">"$\Delta KL$={llik_diff.loc[k]:.1g}"</span>,
         horizontalalignment=<span class="org-string">'right'</span>,
         verticalalignment=<span class="org-string">'top'</span>,
         transform=a.transAxes)
  a.set_title(gene_info.loc[k, <span class="org-string">'name'</span>] <span class="org-keyword">if</span> k <span class="org-keyword">in</span> gene_info.index <span class="org-keyword">else</span> k)
<span class="org-variable-name">handles</span>, <span class="org-variable-name">labels</span> = a.get_legend_handles_labels()
fig.legend(handles, labels, frameon=<span class="org-constant">False</span>, loc=<span class="org-string">'center left'</span>, bbox_to_anchor=(1, 0.5))
<span class="org-keyword">for</span> a <span class="org-keyword">in</span> ax:
  a[0].set_ylabel(<span class="org-string">'Num cells'</span>)
<span class="org-keyword">for</span> a <span class="org-keyword">in</span> ax.T:
  a[-1].set_xlabel(<span class="org-string">'Num mols'</span>)
fig.tight_layout()
</pre>
</div>


<div class="figure">
<p><img src="figure/deconvolution.org/cyto-naive-t-mix-npmle-examples.png" alt="cyto-naive-t-mix-npmle-examples.png">
</p>
</div>

<p>
<i>MALAT1</i> (<a href="https://www.omim.org/entry/607924">Metastasis-associated lung
adenocarcinoma transcript 1</a>) is a lincRNA which appears to show tri-modal
gene expression in this mixture. It is involved in T cell activation,
through interaction with NF-B
(<a href="https://febs.onlinelibrary.wiley.com/doi/full/10.1002/1873-3468.12315">Zhao
et al. 2016</a>).
</p>
</div>
</div>

<div id="outline-container-org97b471c" class="outline-3">
<h3 id="org97b471c">Heterogeneous populations</h3>
<div class="outline-text-3" id="text-org97b471c">
<p>
Read the results.
</p>

<div class="org-src-container">
<pre class="src src-ipython"><span class="org-variable-name">benchmark</span> = {
  k: g.reset_index(level=0, drop=<span class="org-constant">True</span>) <span class="org-keyword">for</span> k, g <span class="org-keyword">in</span>
  (pd.read_csv(<span class="org-string">'/project2/mstephens/aksarkar/projects/singlecell-modes/data/deconv-generalization/heterogeneous-kl.txt.gz'</span>,
               sep=<span class="org-string">'\t'</span>, index_col=[0, 1])
   .groupby(level=0))}
</pre>
</div>

<p>
Fix the cortex count matrix (seems to break the parser in <code>pandas</code>).
</p>

<div class="org-src-container">
<pre class="src src-ipython" id="orgda40fbc"><span class="org-keyword">import</span> scmodes
<span class="org-variable-name">work</span> = scmodes.dataset.cortex(<span class="org-string">'/project2/mstephens/aksarkar/projects/singlecell-ideas/data/zeisel-2015/GSE60361_C1-3005-Expression.txt.gz'</span>, return_df=<span class="org-constant">True</span>)
work.to_csv(<span class="org-string">'/project2/mstephens/aksarkar/projects/singlecell-ideas/data/zeisel-2015/zeisel-2015.txt.gz'</span>, compression=<span class="org-string">'gzip'</span>, sep=<span class="org-string">'\t'</span>)
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh">sbatch --partition=broadwl --mem=16G
<span class="org-comment-delimiter">#</span><span class="org-comment">!/bin/bash</span>
<span class="org-builtin">source</span> activate scmodes
python &lt;&lt;EOF
<span class="org-sh-heredoc">&lt;&lt;fix-cortex&gt;&gt;</span>
EOF
</pre>
</div>

<div class="org-src-container">
<pre class="src src-ipython"><span class="org-variable-name">cortex_counts</span> = pd.read_csv(<span class="org-string">'/project2/mstephens/aksarkar/projects/singlecell-ideas/data/zeisel-2015/zeisel-2015.txt.gz'</span>, sep=<span class="org-string">'\t'</span>, index_col=0)
</pre>
</div>

<p>
Look at the fitted distribution for the genes where NPMLE does worst.
</p>

<div class="org-src-container">
<pre class="src src-ipython"><span class="org-variable-name">llik_diff</span> = benchmark[<span class="org-string">'cortex'</span>][<span class="org-string">'npmle'</span>] - benchmark[<span class="org-string">'cortex'</span>][<span class="org-string">'gamma'</span>]
llik_diff.sort_values().head(n=12)
</pre>
</div>

<pre class="example">
Ttr           -3.136362
Hbb-bs        -3.032071
Hba-a2_loc1   -2.053220
Hba-a2_loc2   -1.985382
Sst           -1.842792
Apoe          -1.414460
Npy           -1.403264
Hbb-b2        -1.365434
Ccl3          -1.226098
Mgp           -1.198429
Acta2         -1.139285
Ptgds         -1.132885
dtype: float64
</pre>

<div class="org-src-container">
<pre class="src src-ipython"><span class="org-variable-name">k</span> = <span class="org-string">'Ttr'</span>
<span class="org-variable-name">x</span> = cortex_counts.loc[:,k].values
<span class="org-variable-name">s</span> = cortex_counts.<span class="org-builtin">sum</span>(axis=1).values

plt.clf()
<span class="org-variable-name">fig</span>, <span class="org-variable-name">ax</span> = plt.subplots(2, 1)
fig.set_size_inches(6, 4)
ax[0].hist(x, bins=np.arange(0, x.<span class="org-builtin">max</span>() + 1, 100), color=<span class="org-string">'k'</span>)
ax[0].set_title(k.upper())
ax[0].set_xlabel(<span class="org-string">'Num mols'</span>)
ax[0].set_ylabel(<span class="org-string">'Num cells'</span>)

<span class="org-keyword">for</span> c, k <span class="org-keyword">in</span> <span class="org-builtin">zip</span>(plt.get_cmap(<span class="org-string">'Dark2'</span>).colors, [<span class="org-string">'Gamma'</span>, <span class="org-string">'ZIG'</span>, <span class="org-string">'Unimodal'</span>, <span class="org-string">'ZIEF'</span>, <span class="org-string">'NPMLE'</span>]):
  ax[1].plot(*<span class="org-builtin">getattr</span>(scmodes.deconvolve, f<span class="org-string">'fit_{k.lower()}'</span>)(x, s), color=c, lw=1, label=k)
ax[1].set_xlabel(<span class="org-string">'Latent gene expression'</span>)
ax[1].set_ylabel(<span class="org-string">'CDF'</span>)
ax[1].legend(frameon=<span class="org-constant">False</span>)
fig.tight_layout()
</pre>
</div>


<div class="figure">
<p><img src="figure/deconvolution.org/cortex-ttr.png" alt="cortex-ttr.png">
</p>
</div>

<p>
Look at the distribution of latent gene expression values (naively
estimated) for <i>TTR</i>.
</p>

<div class="org-src-container">
<pre class="src src-ipython">pd.Series((x / s)[x &gt; 0]).describe()
</pre>
</div>

<pre class="example">
count    90.000000
mean      0.059269
std       0.152847
min       0.000055
25%       0.000368
50%       0.003031
75%       0.008099
max       0.610003
dtype: float64
</pre>

<p>
For these genes, more than 90% of the samples have observed count 0, so the
optimal model appears to predict 0 for all samples.
</p>

<p>
Look at genes where ZIG does better than Gamma.
</p>

<div class="org-src-container">
<pre class="src src-ipython"><span class="org-variable-name">llik_diff</span> = benchmark[<span class="org-string">'cortex'</span>][<span class="org-string">'point_gamma'</span>] - benchmark[<span class="org-string">'cortex'</span>][<span class="org-string">'gamma'</span>]
<span class="org-variable-name">query</span> = benchmark[<span class="org-string">'cortex'</span>].loc[llik_diff[llik_diff &gt; 0].sort_values(ascending=<span class="org-constant">False</span>).head(n=12).index].index
plt.clf()
<span class="org-variable-name">fig</span>, <span class="org-variable-name">ax</span> = plt.subplots(4, 3)
fig.set_size_inches(7, 5)
<span class="org-keyword">for</span> a, k <span class="org-keyword">in</span> <span class="org-builtin">zip</span>(ax.ravel(), query):
  a.hist(cortex_counts.loc[:,k], bins=np.arange(cortex_counts.loc[:,k].<span class="org-builtin">max</span>() + 1), color=<span class="org-string">'k'</span>)
  a.text(x=.95, y=.95,
         s=f<span class="org-string">"$\Delta KL$={llik_diff.loc[k]:.1f}"</span>,
         horizontalalignment=<span class="org-string">'right'</span>,
         verticalalignment=<span class="org-string">'top'</span>,
         transform=a.transAxes)
  a.set_title(k.upper())
<span class="org-keyword">for</span> y <span class="org-keyword">in</span> <span class="org-builtin">range</span>(ax.shape[0]):
  ax[y][0].set_ylabel(<span class="org-string">'Num cells'</span>)
<span class="org-keyword">for</span> x <span class="org-keyword">in</span> <span class="org-builtin">range</span>(ax.shape[1]):
  ax[-1][x].set_xlabel(<span class="org-string">'Num mols'</span>)
fig.tight_layout()
</pre>
</div>


<div class="figure">
<p><img src="figure/deconvolution.org/cortex-zig-examples.png" alt="cortex-zig-examples.png">
</p>
</div>

<p>
Look at genes where unimodal shows greatest performance gain.
</p>

<div class="org-src-container">
<pre class="src src-ipython"><span class="org-variable-name">llik_diff</span> = benchmark[<span class="org-string">'cortex'</span>][<span class="org-string">'unimodal'</span>] - benchmark[<span class="org-string">'cortex'</span>][<span class="org-string">'gamma'</span>]
<span class="org-variable-name">query</span> = benchmark[<span class="org-string">'cortex'</span>].loc[llik_diff[llik_diff &gt; 0].sort_values(ascending=<span class="org-constant">False</span>).head(n=12).index].index
plt.clf()
<span class="org-variable-name">fig</span>, <span class="org-variable-name">ax</span> = plt.subplots(4, 3)
fig.set_size_inches(7, 5)
<span class="org-keyword">for</span> a, k <span class="org-keyword">in</span> <span class="org-builtin">zip</span>(ax.ravel(), query):
  a.hist(cortex_counts.loc[:,k], bins=np.arange(cortex_counts.loc[:,k].<span class="org-builtin">max</span>() + 1), color=<span class="org-string">'k'</span>)
  a.text(x=.95, y=.95,
         s=f<span class="org-string">"$\Delta KL$={llik_diff.loc[k]:.1f}"</span>,
         horizontalalignment=<span class="org-string">'right'</span>,
         verticalalignment=<span class="org-string">'top'</span>,
         transform=a.transAxes)
  a.set_title(k.upper())
<span class="org-keyword">for</span> y <span class="org-keyword">in</span> <span class="org-builtin">range</span>(ax.shape[0]):
  ax[y][0].set_ylabel(<span class="org-string">'Num cells'</span>)
<span class="org-keyword">for</span> x <span class="org-keyword">in</span> <span class="org-builtin">range</span>(ax.shape[1]):
  ax[-1][x].set_xlabel(<span class="org-string">'Num mols'</span>)
fig.tight_layout()

</pre>
</div>


<div class="figure">
<p><img src="figure/deconvolution.org/cortex-unimodal-examples.png" alt="cortex-unimodal-examples.png">
</p>
</div>

<p>
Show genes where NPMLE shows greatest performance gain.
</p>

<div class="org-src-container">
<pre class="src src-ipython"><span class="org-variable-name">llik_diff</span> = benchmark[<span class="org-string">'cortex'</span>][<span class="org-string">'npmle'</span>] - benchmark[<span class="org-string">'cortex'</span>][<span class="org-string">'gamma'</span>]
<span class="org-variable-name">query</span> = benchmark[<span class="org-string">'cortex'</span>].loc[llik_diff[llik_diff &gt; 0].sort_values(ascending=<span class="org-constant">False</span>).head(n=12).index].index
plt.clf()
<span class="org-variable-name">fig</span>, <span class="org-variable-name">ax</span> = plt.subplots(4, 3)
fig.set_size_inches(7, 5)
<span class="org-keyword">for</span> a, k <span class="org-keyword">in</span> <span class="org-builtin">zip</span>(ax.ravel(), query):
  a.hist(cortex_counts.loc[:,k], bins=np.arange(cortex_counts.loc[:,k].<span class="org-builtin">max</span>() + 1), color=<span class="org-string">'k'</span>)
  a.text(x=.95, y=.95,
         s=f<span class="org-string">"$\Delta KL$={llik_diff.loc[k]:.1f}"</span>,
         horizontalalignment=<span class="org-string">'right'</span>,
         verticalalignment=<span class="org-string">'top'</span>,
         transform=a.transAxes)
  a.set_title(k.upper())
<span class="org-keyword">for</span> y <span class="org-keyword">in</span> <span class="org-builtin">range</span>(ax.shape[0]):
  ax[y][0].set_ylabel(<span class="org-string">'Num cells'</span>)
<span class="org-keyword">for</span> x <span class="org-keyword">in</span> <span class="org-builtin">range</span>(ax.shape[1]):
  ax[-1][x].set_xlabel(<span class="org-string">'Num mols'</span>)
fig.tight_layout()
</pre>
</div>


<div class="figure">
<p><img src="figure/deconvolution.org/cortex-npmle-examples.png" alt="cortex-npmle-examples.png">
</p>
</div>

<ul class="org-ul">
<li><i>GPM6A</i> (<a href="https://www.ncbi.nlm.nih.gov/gene/234267">Glycoprotein m6a</a>)
appears to be required for mouse brain develoment, and is expressed in
specific brain regions</li>
<li><i>SCN2A</i> (<a href="https://www.ncbi.nlm.nih.gov/gene/110876">Sodium channel,
voltage-gated, type II, alpha</a>) is needed for propagating actions
potentials in neurons</li>
</ul>

<p>
Stratify the gene expression of these genes by inferred cell type.
</p>

<div class="org-src-container">
<pre class="src src-sh">curl -sLO <span class="org-string">"https://storage.googleapis.com/linnarsson-lab-www-blobs/blobs/cortex/expression_mRNA_17-Aug-2014.txt"</span>
gzip expression_mRNA_17-Aug-2014.txt
</pre>
</div>

<div class="org-src-container">
<pre class="src src-ipython"><span class="org-variable-name">cortex_celltypes</span> = (pd.read_csv(<span class="org-string">'/project2/mstephens/aksarkar/projects/singlecell-ideas/data/zeisel-2015/expression_mRNA_17-Aug-2014.txt.gz'</span>, sep=<span class="org-string">'\t'</span>, header=<span class="org-constant">None</span>, index_col=0, nrows=10)
                    .reset_index(drop=<span class="org-constant">True</span>)
                    .set_index(1))
</pre>
</div>

<div class="org-src-container">
<pre class="src src-ipython">plt.clf()
<span class="org-variable-name">fig</span>, <span class="org-variable-name">ax</span> = plt.subplots(3, 3)
fig.set_size_inches(6, 6)
<span class="org-keyword">for</span> a, k <span class="org-keyword">in</span> <span class="org-builtin">zip</span>(ax.ravel(), <span class="org-builtin">set</span>(cortex_celltypes.loc[<span class="org-string">'level1class'</span>])):
  <span class="org-variable-name">x</span> = cortex_counts.loc[(cortex_celltypes.loc[<span class="org-string">'level1class'</span>] == k).values, <span class="org-string">'Gpm6a'</span>]
  a.hist(x, bins=np.arange(x.<span class="org-builtin">max</span>() + 1), color=<span class="org-string">'k'</span>)
  a.set_title(k)
<span class="org-keyword">for</span> a <span class="org-keyword">in</span> ax:
  a[0].set_ylabel(<span class="org-string">'Num cells'</span>)
<span class="org-keyword">for</span> a <span class="org-keyword">in</span> ax.T:
  a[-1].set_xlabel(<span class="org-string">'Num mols'</span>)
fig.tight_layout()
</pre>
</div>


<div class="figure">
<p><img src="figure/deconvolution.org/cortex-gpm6a.png" alt="cortex-gpm6a.png">
</p>
</div>

<div class="org-src-container">
<pre class="src src-ipython">plt.clf()
<span class="org-variable-name">fig</span>, <span class="org-variable-name">ax</span> = plt.subplots(3, 3)
fig.set_size_inches(6, 6)
<span class="org-keyword">for</span> a, k <span class="org-keyword">in</span> <span class="org-builtin">zip</span>(ax.ravel(), <span class="org-builtin">set</span>(cortex_celltypes.loc[<span class="org-string">'level1class'</span>])):
  <span class="org-variable-name">x</span> = cortex_counts.loc[(cortex_celltypes.loc[<span class="org-string">'level1class'</span>] == k).values, <span class="org-string">'Scn2a1'</span>]
  a.hist(x, bins=np.arange(x.<span class="org-builtin">max</span>() + 1), color=<span class="org-string">'k'</span>)
  a.set_title(k)
<span class="org-keyword">for</span> a <span class="org-keyword">in</span> ax:
  a[0].set_ylabel(<span class="org-string">'Num cells'</span>)
<span class="org-keyword">for</span> a <span class="org-keyword">in</span> ax.T:
  a[-1].set_xlabel(<span class="org-string">'Num mols'</span>)
fig.tight_layout()
</pre>
</div>


<div class="figure">
<p><img src="figure/deconvolution.org/cortex-scn2a.png" alt="cortex-scn2a.png">
</p>
</div>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: Abhishek Sarkar</p>
<p class="date">Created: 2019-05-23 Thu 15:32</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
