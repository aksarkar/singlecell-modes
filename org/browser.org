#+TITLE: Interactive simulations
#+SETUPFILE: setup.org
#+PROPERTY: header-args:sh :eval never-export :results output

* Test environment

  Get a local compute node.

  #+BEGIN_SRC sh :session midway2
    srun -n1 --partition=broadwl --pty bash
    cd /project2/mstephens/aksarkar/projects/singlecell-modes/browser/
    source activate scmodes
  #+END_SRC

  #+RESULTS:
  : srun -n1 --partition=broadwl --pty bash
  : cd /project2/mstephens/aksarkar/projects/singlecell-modes/browser/ [A[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[C[K/
  : source activate scmodes

  (Re)start the browser

  #+BEGIN_SRC sh :session midway2
    pkill -u aksarkar bokeh
    bokeh serve capture --address $(hostname -i) --allow-websocket-origin=$(hostname -i):5006 &
    echo "http://$(hostname -i):5006"
  #+END_SRC

  #+RESULTS:
  : pkill -u aksarkar bokeh
  : Received signal 15, shutting down
  : (hostname -i) --allow-websocket-origin=$(hostname -i):5006
  : bokeh serve capture --address $(hostname -i) --allow-web socket-origin=$(hostname -i):5006 &
  : [7] 35512
  : echo "http://$(hostname -i):5006"
  : echo 'org_babel_sh_eoe'
  : http://10.50.221.104:5006

* Production environment

  Start a remote session on ~shiny.stephenslab.uchicago.edu~.

  #+BEGIN_SRC sh :session shiny
    ssh shiny
  #+END_SRC

  #+RESULTS:
  #+begin_example

  Welcome to Ubuntu 18.04.1 LTS (GNU/Linux 4.15.0-43-generic x86_64)

   ,* Documentation:  https://help.ubuntu.com
   ,* Management:     https://landscape.canonical.com
   ,* Support:        https://ubuntu.com/advantage

    System information as of Wed Jun  5 23:41:06 CDT 2019

    System load:                    0.06
  of 1.79TB

  Processes:                      207
    Users logged in:                0
    IP address for enp3s0:          128.135.144.117
    IP address for docker0:         172.17.0.1
    IP address for br-186257bda03d: 172.18.0.1

   ,* Ubuntu's Kubernetes 1.14 distributions can bypass Docker and use containerd
     directly, see https://bit.ly/ubuntu-containerd or try it now with

       snap install microk8s --classic

   ,* Canonical Livepatch is available for installation.
     - Reduce system reboots and improve kernel security. Activate at:
       https://ubuntu.com/livepatch

  236 packages can be updated.
  0 updates are security updates.


  ,*** System restart required ***
  Last login: Fri May 17 23:26:52 2019 from 128.135.112.68
  #+end_example

  Add the Debian Stretch box using the full URL.

  #+BEGIN_SRC sh :session shiny
    vagrant box add --provider=virtualbox "https://app.vagrantup.com/debian/boxes/stretch64"
  #+END_SRC

  #+RESULTS:
  #+BEGIN_EXAMPLE
    ==> box: Loading metadata for box 'https://app.vagrantup.com/debian/boxes/stretch64'
    echo 'org_babel_sh_eoe'
    ==> box: Adding box 'debian/stretch64' (v9.5.0) for provider: virtualbox
        box: Downloading: https://vagrantcloud.com/debian/boxes/stretch64/versions/9.5.0/providers/virtualbox.box
    ==> box: Successfully added box 'debian/stretch64' (v9.5.0) for 'virtualbox'!
  #+END_EXAMPLE

  Initialize the VM.

  #+BEGIN_SRC ruby :eval never :tangle /ssh:shiny:/home/aksarkar/singlecell-modes/Vagrantfile
    Vagrant.configure(2) do |config|
      config.vm.box = "debian/stretch64"
      config.vm.network "forwarded_port", guest: 5006, host: 5008
      config.vm.provider "virtualbox" do |vb|
        vb.name = "singlecell-modes"
        vb.customize ["modifyvm", :id, "--cableconnected1", "on"]
      end
      config.vm.provision "shell", inline: <<-SHELL
        apt-get update
        apt-get install git
        # https://github.com/chef/bento/issues/661#issuecomment-248136601
        DEBIAN_FRONTEND=noninteractive apt-get -y -o Dpkg::Options::="--force-confdef" -o Dpkg::Options::="--force-confold" upgrade
      SHELL
    end

    # -*- mode: ruby -*-
  #+END_SRC

  #+BEGIN_SRC ipython
    cd ~/singlecell-modes
    vagrant up --provision
  #+END_SRC

  (Re)start the VM.

  #+BEGIN_SRC sh :session shiny
    cd ~/singlecell-modes
    vagrant halt
    vagrant up --no-provision
  #+END_SRC

  #+RESULTS:
  #+begin_example

  aksarkar@shiny:~/singlecell-modes$ [0mBringing machine 'default' up with 'virtualbox' provider...[0m
  default: Checking if box 'debian/stretch64' is up to date...[0m
  default: Clearing any previously set forwarded ports...[0m
  default: Fixed port collision for 22 => 2222. Now on port 2200.[0m
  default: Clearing any previously set network interfaces...[0m
  default: Preparing network interfaces based on configuration...[0m
  [0m    default: Adapter 1: nat[0m
  default: Forwarding ports...[0m
  5008 (host) (adapter 1)[0m
  2200 (host) (adapter 1)[0m
  default: Running 'pre-boot' VM customizations...[0m
  default: Booting VM...[0m
  default: Waiting for machine to boot. This may take a few minutes...[0m
  [0m    default: SSH address: 127.0.0.1:2200[0m
  [0m    default: SSH username: vagrant[0m
  [0m    default: SSH auth method: private key[0m
  default: Machine booted and ready![0m
  default: Checking for guest additions in VM...[0m
  [0m    default: No guest additions were detected on the base box for this VM! Guest
      default: additions are required for forwarded ports, shared folders, host only
      default: networking, and more. If SSH fails on this machine, please install
      default: the guest additions and repackage the box to continue.
      default: 
      default: This is not an error message; everything may continue to work properly,
      default: in which case you may ignore this message.[0m
  default: Rsyncing folder: /home/aksarkar/singlecell-modes/ => /vagrant[0m
  default: Machine not provisioned because `--no-provision` is specified.[0m
  [0m[0m
  default: Machine 'default' has a post `vagrant up` message. This is a message
  default: from the creator of the Vagrantfile, and not from Vagrant itself:
  default:
  default: Vanilla Debian box. See https://app.vagrantup.com/debian for help and bug reports[0m
  #+end_example

  ssh into the VM.

  #+BEGIN_SRC sh :session shiny
    vagrant global-status
  #+END_SRC

  #+RESULTS:
  #+begin_example
  [0mid       [0m[0mname    [0m[0mprovider   [0m[0mstate    [0m[0mdirectory                           [0m[0m[0m
  [0m-------------------------------------------------------------------------[0m
  [0m21c0820  [0m[0mdefault [0m[0mvirtualbox [0m[0mrunning  [0m[0m/home/aksarkar/scqtl-browser        [0m[0m[0m
  [0m79a6f03  [0m[0mdefault [0m[0mvirtualbox [0m[0mpoweroff [0m[0m/home/aksarkar/debian-testing       [0m[0m[0m
  [0mf7b1184  [0m[0mdefault [0m[0mvirtualbox [0m[0mrunning  [0m[0m/home/aksarkar/singlecell-modes              [0m[0m[0m
  [0m 
  The above shows information about all known Vagrant environments
  on this machine. This data is cached and may not be completely
  up-to-date. To interact with any of the machines, you can go to
  that directory and run Vagrant, or you can use the ID directly
  with Vagrant commands from any directory. For example:
  "vagrant destroy 1a2b3c4d"[0m
  #+end_example

  #+BEGIN_SRC sh :session shiny
    vagrant ssh f7b1184
  #+END_SRC

  #+RESULTS:
  #+begin_example

  1 SMP Debian 4.9.168-1+deb9u2 (2019-05-13) x86_64

  The programs included with the Debian GNU/Linux system are free software;
  the exact distribution terms for each program are described in the
  individual files in /usr/share/doc/*/copyright.

  Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
  permitted by applicable law.
  Last login: Thu Jun  6 05:16:11 2019 from 10.0.2.2
  #+end_example

  The data are available on the VM under ~/vagrant~. Fake the location of the
  database as it appears on the test server (~*.midway2.rcc.uchicago.edu~).

  #+BEGIN_SRC sh :session shiny
    sudo mkdir -p /project2/mstephens/aksarkar/projects/singlecell-modes/
    sudo ln -s /vagrant /project2/mstephens/aksarkar/projects/singlecell-modes/browser
  #+END_SRC

  #+RESULTS:

  Install ~miniconda3~ as user ~vagrant~.

  #+BEGIN_SRC sh :session shiny
    wget -q https://repo.continuum.io/miniconda/Miniconda3-latest-Linux-x86_64.sh
    bash Miniconda3-latest-Linux-x86_64.sh -b
    echo "export PATH=$PATH:$HOME/miniconda3/bin" >>$HOME/.bashrc
    . $HOME/.bashrc
  #+END_SRC

  #+RESULTS:
  #+begin_example

  PREFIX=/home/vagrant/miniconda3
  installing: python-3.7.3-h0371630_0 ...
  Python 3.7.3
  installing: ca-certificates-2019.1.23-0 ...
  installing: libgcc-ng-8.2.0-hdf63c60_1 ...
  installing: libstdcxx-ng-8.2.0-hdf63c60_1 ...
  installing: libffi-3.2.1-hd88cf55_4 ...
  installing: ncurses-6.1-he6710b0_1 ...
  installing: openssl-1.1.1b-h7b6447c_1 ...
  installing: xz-5.2.4-h14c3975_4 ...
  installing: yaml-0.1.7-had09818_2 ...
  installing: zlib-1.2.11-h7b6447c_3 ...
  installing: libedit-3.1.20181209-hc058e9b_0 ...
  installing: readline-7.0-h7b6447c_5 ...
  installing: tk-8.6.8-hbc83047_0 ...
  installing: sqlite-3.27.2-h7b6447c_0 ...
  installing: asn1crypto-0.24.0-py37_0 ...
  installing: certifi-2019.3.9-py37_0 ...
  installing: chardet-3.0.4-py37_1 ...
  installing: idna-2.8-py37_0 ...
  installing: pycosat-0.6.3-py37h14c3975_0 ...
  installing: pycparser-2.19-py37_0 ...
  installing: pysocks-1.6.8-py37_0 ...
  installing: ruamel_yaml-0.15.46-py37h14c3975_0 ...
  installing: six-1.12.0-py37_0 ...
  installing: cffi-1.12.2-py37h2e261b9_1 ...
  installing: setuptools-41.0.0-py37_0 ...
  installing: cryptography-2.6.1-py37h1ba5d50_0 ...
  installing: wheel-0.33.1-py37_0 ...
  installing: pip-19.0.3-py37_0 ...
  installing: pyopenssl-19.0.0-py37_0 ...
  installing: urllib3-1.24.1-py37_0 ...
  installing: requests-2.21.0-py37_0 ...
  installing: conda-4.6.14-py37_0 ...
  installation finished.
  #+end_example

  Initialize a new environment.

  #+BEGIN_SRC sh :session shiny
    conda update -yn base conda
    conda create -yqn "singlecell-modes" numpy scipy pandas bokeh=1.2.0=py37_0
  #+END_SRC

  #+RESULTS:
  #+begin_example
  Collecting package metadata: - \ | / - \ | / - \ | / - \ | / - \ | / - \ | / - done
  Solving environment: | / - \ | / - \ | done
  # Package Plan ##

    environment location: /home/vagrant/miniconda3

    added / updated specs:
      - conda


  The following packages will be downloaded:

      package                    |            build
      ---------------------------|-----------------
      ca-certificates-2019.5.15  |                0         133 KB
      openssl-1.1.1c             |       h7b6447c_1         3.8 MB
      ------------------------------------------------------------
                                             Total:         3.9 MB

  The following packages will be UPDATED:
  2019.5.15-0
  1.1.1c-h7b6447c_1



  Downloading and Extracting Packages
  openssl-1.1.1c       | 3.8 MB    | ###################2                                                                                          |  18% openssl-1.1.1c       | 3.8 MB    | ###########################################8                                                                  |  40% openssl-1.1.1c       | 3.8 MB    | ####################################################################4                                         |  63% openssl-1.1.1c       | 3.8 MB    | #####################################################################################6                        |  79% openssl-1.1.1c       | 3.8 MB    | #####################################################################################################5        |  93% openssl-1.1.1c       | 3.8 MB    | ############################################################################################################# | 100%
  ca-certificates-2019 | 133 KB    | ############################################################################################################# | 100% 
  Preparing transaction: - done
  Verifying transaction: | done
  Executing transaction: - done
  Collecting package metadata: ...working... done
  Solving environment: ...working... done
  # Package Plan ##

    environment location: /home/vagrant/miniconda3/envs/singlecell-modes

    added / updated specs:
      - bokeh==1.2.0=py37_0
      - numpy
      - pandas
      - scipy


  The following packages will be downloaded:

      package                    |            build
      ---------------------------|-----------------
      blas-1.0                   |              mkl           6 KB
      bokeh-1.2.0                |           py37_0         3.9 MB
      freetype-2.9.1             |       h8a8886c_1         822 KB
      intel-openmp-2019.4        |              243         876 KB
      jinja2-2.10.1              |           py37_0         188 KB
      jpeg-9b                    |       h024ee3a_2         248 KB
      libgfortran-ng-7.3.0       |       hdf63c60_0         1.3 MB
      libpng-1.6.37              |       hbc83047_0         364 KB
      libtiff-4.0.10             |       h2733197_2         604 KB
      markupsafe-1.1.1           |   py37h7b6447c_0          29 KB
      mkl-2019.4                 |              243       204.1 MB
      mkl_fft-1.0.12             |   py37ha843d7b_0         172 KB
      mkl_random-1.0.2           |   py37hd81dba3_0         405 KB
      numpy-1.16.4               |   py37h7e9f1db_0          49 KB
      numpy-base-1.16.4          |   py37hde5b4d6_0         4.4 MB
      olefile-0.46               |           py37_0          48 KB
      packaging-19.0             |           py37_0          38 KB
      pandas-0.24.2              |   py37he6710b0_0        11.1 MB
      pillow-6.0.0               |   py37h34e0f95_0         624 KB
      pip-19.1.1                 |           py37_0         1.8 MB
      pyparsing-2.4.0            |             py_0          58 KB
      python-dateutil-2.8.0      |           py37_0         281 KB
      pytz-2019.1                |             py_0         236 KB
      pyyaml-5.1                 |   py37h7b6447c_0         188 KB
      scipy-1.2.1                |   py37h7c811a0_0        17.7 MB
      setuptools-41.0.1          |           py37_0         648 KB
      sqlite-3.28.0              |       h7b6447c_0         1.9 MB
      tornado-6.0.2              |   py37h7b6447c_0         642 KB
      wheel-0.33.4               |           py37_0          39 KB
      zstd-1.3.7                 |       h0b5b093_0         887 KB
      ------------------------------------------------------------
                                             Total:       253.3 MB

  The following NEW packages will be INSTALLED:

    blas               pkgs/main/linux-64::blas-1.0-mkl
    bokeh              pkgs/main/linux-64::bokeh-1.2.0-py37_0
    ca-certificates    pkgs/main/linux-64::ca-certificates-2019.5.15-0
    certifi            pkgs/main/linux-64::certifi-2019.3.9-py37_0
    freetype           pkgs/main/linux-64::freetype-2.9.1-h8a8886c_1
    intel-openmp       pkgs/main/linux-64::intel-openmp-2019.4-243
    jinja2             pkgs/main/linux-64::jinja2-2.10.1-py37_0
    jpeg               pkgs/main/linux-64::jpeg-9b-h024ee3a_2
    libedit            pkgs/main/linux-64::libedit-3.1.20181209-hc058e9b_0
    libffi             pkgs/main/linux-64::libffi-3.2.1-hd88cf55_4
    libgcc-ng          pkgs/main/linux-64::libgcc-ng-8.2.0-hdf63c60_1
    libgfortran-ng     pkgs/main/linux-64::libgfortran-ng-7.3.0-hdf63c60_0
    libpng             pkgs/main/linux-64::libpng-1.6.37-hbc83047_0
    libstdcxx-ng       pkgs/main/linux-64::libstdcxx-ng-8.2.0-hdf63c60_1
    libtiff            pkgs/main/linux-64::libtiff-4.0.10-h2733197_2
    markupsafe         pkgs/main/linux-64::markupsafe-1.1.1-py37h7b6447c_0
    mkl                pkgs/main/linux-64::mkl-2019.4-243
    mkl_fft            pkgs/main/linux-64::mkl_fft-1.0.12-py37ha843d7b_0
    mkl_random         pkgs/main/linux-64::mkl_random-1.0.2-py37hd81dba3_0
    ncurses            pkgs/main/linux-64::ncurses-6.1-he6710b0_1
    numpy              pkgs/main/linux-64::numpy-1.16.4-py37h7e9f1db_0
    numpy-base         pkgs/main/linux-64::numpy-base-1.16.4-py37hde5b4d6_0
    olefile            pkgs/main/linux-64::olefile-0.46-py37_0
    openssl            pkgs/main/linux-64::openssl-1.1.1c-h7b6447c_1
    packaging          pkgs/main/linux-64::packaging-19.0-py37_0
    pandas             pkgs/main/linux-64::pandas-0.24.2-py37he6710b0_0
    pillow             pkgs/main/linux-64::pillow-6.0.0-py37h34e0f95_0
    pip                pkgs/main/linux-64::pip-19.1.1-py37_0
    pyparsing          pkgs/main/noarch::pyparsing-2.4.0-py_0
    python             pkgs/main/linux-64::python-3.7.3-h0371630_0
    python-dateutil    pkgs/main/linux-64::python-dateutil-2.8.0-py37_0
    pytz               pkgs/main/noarch::pytz-2019.1-py_0
    pyyaml             pkgs/main/linux-64::pyyaml-5.1-py37h7b6447c_0
    readline           pkgs/main/linux-64::readline-7.0-h7b6447c_5
    scipy              pkgs/main/linux-64::scipy-1.2.1-py37h7c811a0_0
    setuptools         pkgs/main/linux-64::setuptools-41.0.1-py37_0
    six                pkgs/main/linux-64::six-1.12.0-py37_0
    sqlite             pkgs/main/linux-64::sqlite-3.28.0-h7b6447c_0
    tk                 pkgs/main/linux-64::tk-8.6.8-hbc83047_0
    tornado            pkgs/main/linux-64::tornado-6.0.2-py37h7b6447c_0
    wheel              pkgs/main/linux-64::wheel-0.33.4-py37_0
    xz                 pkgs/main/linux-64::xz-5.2.4-h14c3975_4
    yaml               pkgs/main/linux-64::yaml-0.1.7-had09818_2
    zlib               pkgs/main/linux-64::zlib-1.2.11-h7b6447c_3
    zstd               pkgs/main/linux-64::zstd-1.3.7-h0b5b093_0


  Preparing transaction: ...working... done
  Verifying transaction: ...working... done
  Executing transaction: ...working... done
  #+end_example

  ~rsync~ the code and data to the server.

  #+BEGIN_SRC sh :dir /scratch/midway2/aksarkar/singlecell
    sbatch --partition=broadwl --job-name=rsync
    #!/bin/bash
    rsync -au /project2/mstephens/aksarkar/projects/singlecell-modes/browser/ shiny:singlecell-modes/
  #+END_SRC

  #+RESULTS:
  : Submitted batch job 60673570

  Start the QTL browser. The code/data are available under ~/vagrant~ inside the VM.

  #+BEGIN_SRC sh :session shiny
    cd /vagrant
    source activate singlecell-modes
    nohup bokeh serve qtls --port 5006 --allow-websocket-origin=shiny.stephenslab.uchicago.edu:5008 &
  #+END_SRC

  #+RESULTS:
  : 
  : (singlecell-modes) vagrant@stretch:/vagrant$ [1] 652
